<!--
WARNING: These targets are intended for building Microsoft's ASP.NET Core repos, and is not intended
for use outside of Microsoft.
-->

<!-- this file is dedicated to working around bugs in Microsoft.NET.Sdk RC.2 release -->
<Project>
    <!-- workaround https://github.com/Microsoft/vstest/issues/191 -->
    <PropertyGroup
        Condition="$(MSBuildProjectName.EndsWith('Test')) OR $(MSBuildProjectName.EndsWith('Tests'))">
        <OutputType Condition="$(TargetFramework.StartsWith('netcoreapp'))">exe</OutputType>
    </PropertyGroup>
    <!-- end workaround -->

    <!-- workaround https://github.com/NuGet/Home/issues/4063 -->
    <!-- workaround https://github.com/NuGet/Home/issues/3953 -->
    <Target Name="ResolveActualPackageVersionsInner"
            BeforeTargets="GenerateNuSpec"
            DependsOnTargets="ResolvePackageDependenciesDesignTime">

        <PropertyGroup>
          <_P2PVersion>$(Version)</_P2PVersion>
          <_P2PVersion Condition="'$(PackageVersion)'!=''">$(PackageVersion)</_P2PVersion>
        </PropertyGroup>

        <ItemGroup>
            <_ProjectReferences Update="@(_ProjectReferences)" Condition="'%(PackageVersion)'==''">
                <PackageVersion>$(_P2PVersion)</PackageVersion>
            </_ProjectReferences>

            <_FloatingVersions Include="@(_PackageReferences)" Condition="$([System.String]::new('%(Version)').EndsWith('*'))" />
            <_ResolvedFloatingVersion Include="@(_FloatingVersions)">
                <ResolvedName>%(_DependenciesDesignTime.Name)</ResolvedName>
                <Version>%(_DependenciesDesignTime.Version)</Version>
            </_ResolvedFloatingVersion>
            <_PackageReferences Remove="@(_PackageReferences)" Condition="$([System.String]::new('%(Version)').EndsWith('*'))" />
            <_PackageReferences Include="@(_ResolvedFloatingVersion)" Condition="'%(Identity)'=='%(_ResolvedFloatingVersion.ResolvedName)'" />
        </ItemGroup>

        <Message Importance="Low" Text="Proj: %(_ProjectReferences.FileName) %(_ProjectReferences.PackageVersion)" />
        <Message Importance="Low" Text="Pkg: %(_PackageReferences.Identity) %(_PackageReferences.Version)" />
    </Target>
    <!-- end workaround -->

    <!-- workaround https://github.com/dotnet/sdk/issues/490 -->
    <ItemGroup>
        <!-- TODO use contentFiles in this package instead -->
        <!-- checking DesignTimeBuild hides the file from from VS solution explorer which does not yet support 'Visible' -->
        <!-- see https://github.com/dotnet/roslyn-project-system/issues/1126-->
        <Compile Include="$(MSBuildThisFileDirectory)AssemblyInfo.Serviceable.cs"
                 Condition="'$(DesignTimeBuild)'!='true'"
                 Visible="false" />
    </ItemGroup>
    <!-- end workaround -->
</Project>